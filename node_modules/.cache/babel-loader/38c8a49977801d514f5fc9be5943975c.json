{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar ethereumjs_util_1 = require(\"ethereumjs-util\");\n\nvar ethereumjs_common_1 = require(\"ethereumjs-common\");\n\nvar buffer_1 = require(\"buffer\"); // secp256k1n/2\n\n\nvar N_DIV_2 = new ethereumjs_util_1.BN('7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0', 16);\n/**\n * An Ethereum transaction.\n */\n\nvar Transaction =\n/** @class */\nfunction () {\n  /**\n   * Creates a new transaction from an object with its fields' values.\n   *\n   * @param data - A transaction can be initialized with its rlp representation, an array containing\n   * the value of its fields in order, or an object containing them by name.\n   *\n   * @param opts - The transaction's options, used to indicate the chain and hardfork the\n   * transactions belongs to.\n   *\n   * @note Transaction objects implement EIP155 by default. To disable it, use the constructor's\n   * second parameter to set a chain and hardfork before EIP155 activation (i.e. before Spurious\n   * Dragon.)\n   *\n   * @example\n   * ```js\n   * const txData = {\n   *   nonce: '0x00',\n   *   gasPrice: '0x09184e72a000',\n   *   gasLimit: '0x2710',\n   *   to: '0x0000000000000000000000000000000000000000',\n   *   value: '0x00',\n   *   data: '0x7f7465737432000000000000000000000000000000000000000000000000000000600057',\n   *   v: '0x1c',\n   *   r: '0x5e1d3a76fbf824220eafc8c79ad578ad2b67d01b0c2425eb1f1347e8f50882ab',\n   *   s: '0x5bd428537f05f9830e93792f90ea6a3e2d1ee84952dd96edbae9f658f831ab13'\n   * };\n   * const tx = new Transaction(txData);\n   * ```\n   */\n  function Transaction(data, opts) {\n    if (data === void 0) {\n      data = {};\n    }\n\n    if (opts === void 0) {\n      opts = {};\n    } // instantiate Common class instance based on passed options\n\n\n    if (opts.common) {\n      if (opts.chain || opts.hardfork) {\n        throw new Error('Instantiation with both opts.common, and opts.chain and opts.hardfork parameter not allowed!');\n      }\n\n      this._common = opts.common;\n    } else {\n      var chain = opts.chain ? opts.chain : 'mainnet';\n      var hardfork = opts.hardfork ? opts.hardfork : 'petersburg';\n      this._common = new ethereumjs_common_1.default(chain, hardfork);\n    } // Define Properties\n\n\n    var fields = [{\n      name: 'nonce',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'gasPrice',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'gasLimit',\n      alias: 'gas',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'to',\n      allowZero: true,\n      length: 20,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'value',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'data',\n      alias: 'input',\n      allowZero: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'v',\n      allowZero: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'r',\n      length: 32,\n      allowZero: true,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 's',\n      length: 32,\n      allowZero: true,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }]; // attached serialize\n\n    ethereumjs_util_1.defineProperties(this, fields, data);\n    /**\n     * @property {Buffer} from (read only) sender address of this transaction, mathematically derived from other parameters.\n     * @name from\n     * @memberof Transaction\n     */\n\n    Object.defineProperty(this, 'from', {\n      enumerable: true,\n      configurable: true,\n      get: this.getSenderAddress.bind(this)\n    });\n\n    this._validateV(this.v);\n\n    this._overrideVSetterWithValidation();\n  }\n  /**\n   * If the tx's `to` is to the creation address\n   */\n\n\n  Transaction.prototype.toCreationAddress = function () {\n    return this.to.toString('hex') === '';\n  };\n  /**\n   * Computes a sha3-256 hash of the serialized tx\n   * @param includeSignature - Whether or not to include the signature\n   */\n\n\n  Transaction.prototype.hash = function (includeSignature) {\n    if (includeSignature === void 0) {\n      includeSignature = true;\n    }\n\n    var items;\n\n    if (includeSignature) {\n      items = this.raw;\n    } else {\n      if (this._implementsEIP155()) {\n        items = this.raw.slice(0, 6).concat([ethereumjs_util_1.toBuffer(this.getChainId()), // TODO: stripping zeros should probably be a responsibility of the rlp module\n        ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0)), ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0))]);\n      } else {\n        items = this.raw.slice(0, 6);\n      }\n    } // create hash\n\n\n    return ethereumjs_util_1.rlphash(items);\n  };\n  /**\n   * returns chain ID\n   */\n\n\n  Transaction.prototype.getChainId = function () {\n    return this._common.chainId();\n  };\n  /**\n   * returns the sender's address\n   */\n\n\n  Transaction.prototype.getSenderAddress = function () {\n    if (this._from) {\n      return this._from;\n    }\n\n    var pubkey = this.getSenderPublicKey();\n    this._from = ethereumjs_util_1.publicToAddress(pubkey);\n    return this._from;\n  };\n  /**\n   * returns the public key of the sender\n   */\n\n\n  Transaction.prototype.getSenderPublicKey = function () {\n    if (!this.verifySignature()) {\n      throw new Error('Invalid Signature');\n    } // If the signature was verified successfully the _senderPubKey field is defined\n\n\n    return this._senderPubKey;\n  };\n  /**\n   * Determines if the signature is valid\n   */\n\n\n  Transaction.prototype.verifySignature = function () {\n    var msgHash = this.hash(false); // All transaction signatures whose s-value is greater than secp256k1n/2 are considered invalid.\n\n    if (this._common.gteHardfork('homestead') && new ethereumjs_util_1.BN(this.s).cmp(N_DIV_2) === 1) {\n      return false;\n    }\n\n    try {\n      var v = ethereumjs_util_1.bufferToInt(this.v);\n\n      var useChainIdWhileRecoveringPubKey = v >= this.getChainId() * 2 + 35 && this._common.gteHardfork('spuriousDragon');\n\n      this._senderPubKey = ethereumjs_util_1.ecrecover(msgHash, v, this.r, this.s, useChainIdWhileRecoveringPubKey ? this.getChainId() : undefined);\n    } catch (e) {\n      return false;\n    }\n\n    return !!this._senderPubKey;\n  };\n  /**\n   * sign a transaction with a given private key\n   * @param privateKey - Must be 32 bytes in length\n   */\n\n\n  Transaction.prototype.sign = function (privateKey) {\n    // We clear any previous signature before signing it. Otherwise, _implementsEIP155's can give\n    // different results if this tx was already signed.\n    this.v = new buffer_1.Buffer([]);\n    this.s = new buffer_1.Buffer([]);\n    this.r = new buffer_1.Buffer([]);\n    var msgHash = this.hash(false);\n    var sig = ethereumjs_util_1.ecsign(msgHash, privateKey);\n\n    if (this._implementsEIP155()) {\n      sig.v += this.getChainId() * 2 + 8;\n    }\n\n    Object.assign(this, sig);\n  };\n  /**\n   * The amount of gas paid for the data in this tx\n   */\n\n\n  Transaction.prototype.getDataFee = function () {\n    var data = this.raw[5];\n    var cost = new ethereumjs_util_1.BN(0);\n\n    for (var i = 0; i < data.length; i++) {\n      data[i] === 0 ? cost.iaddn(this._common.param('gasPrices', 'txDataZero')) : cost.iaddn(this._common.param('gasPrices', 'txDataNonZero'));\n    }\n\n    return cost;\n  };\n  /**\n   * the minimum amount of gas the tx must have (DataFee + TxFee + Creation Fee)\n   */\n\n\n  Transaction.prototype.getBaseFee = function () {\n    var fee = this.getDataFee().iaddn(this._common.param('gasPrices', 'tx'));\n\n    if (this._common.gteHardfork('homestead') && this.toCreationAddress()) {\n      fee.iaddn(this._common.param('gasPrices', 'txCreation'));\n    }\n\n    return fee;\n  };\n  /**\n   * the up front amount that an account must have for this transaction to be valid\n   */\n\n\n  Transaction.prototype.getUpfrontCost = function () {\n    return new ethereumjs_util_1.BN(this.gasLimit).imul(new ethereumjs_util_1.BN(this.gasPrice)).iadd(new ethereumjs_util_1.BN(this.value));\n  };\n\n  Transaction.prototype.validate = function (stringError) {\n    if (stringError === void 0) {\n      stringError = false;\n    }\n\n    var errors = [];\n\n    if (!this.verifySignature()) {\n      errors.push('Invalid Signature');\n    }\n\n    if (this.getBaseFee().cmp(new ethereumjs_util_1.BN(this.gasLimit)) > 0) {\n      errors.push([\"gas limit is too low. Need at least \" + this.getBaseFee()]);\n    }\n\n    if (stringError === false) {\n      return errors.length === 0;\n    } else {\n      return errors.join(' ');\n    }\n  };\n  /**\n   * Returns the rlp encoding of the transaction\n   */\n\n\n  Transaction.prototype.serialize = function () {\n    // Note: This never gets executed, defineProperties overwrites it.\n    return ethereumjs_util_1.rlp.encode(this.raw);\n  };\n  /**\n   * Returns the transaction in JSON format\n   * @see {@link https://github.com/ethereumjs/ethereumjs-util/blob/master/docs/index.md#defineproperties|ethereumjs-util}\n   */\n\n\n  Transaction.prototype.toJSON = function (labels) {\n    if (labels === void 0) {\n      labels = false;\n    } // Note: This never gets executed, defineProperties overwrites it.\n\n\n    return {};\n  };\n\n  Transaction.prototype._validateV = function (v) {\n    if (v === undefined || v.length === 0) {\n      return;\n    }\n\n    if (!this._common.gteHardfork('spuriousDragon')) {\n      return;\n    }\n\n    var vInt = ethereumjs_util_1.bufferToInt(v);\n\n    if (vInt === 27 || vInt === 28) {\n      return;\n    }\n\n    var isValidEIP155V = vInt === this.getChainId() * 2 + 35 || vInt === this.getChainId() * 2 + 36;\n\n    if (!isValidEIP155V) {\n      throw new Error(\"Incompatible EIP155-based V \" + vInt + \" and chain id \" + this.getChainId() + \". See the second parameter of the Transaction constructor to set the chain id.\");\n    }\n  };\n\n  Transaction.prototype._isSigned = function () {\n    return this.v.length > 0 && this.r.length > 0 && this.s.length > 0;\n  };\n\n  Transaction.prototype._overrideVSetterWithValidation = function () {\n    var _this = this;\n\n    var vDescriptor = Object.getOwnPropertyDescriptor(this, 'v');\n    Object.defineProperty(this, 'v', __assign({}, vDescriptor, {\n      set: function set(v) {\n        if (v !== undefined) {\n          _this._validateV(ethereumjs_util_1.toBuffer(v));\n        }\n\n        vDescriptor.set(v);\n      }\n    }));\n  };\n\n  Transaction.prototype._implementsEIP155 = function () {\n    var onEIP155BlockOrLater = this._common.gteHardfork('spuriousDragon');\n\n    if (!this._isSigned()) {\n      // We sign with EIP155 all unsigned transactions after spuriousDragon\n      return onEIP155BlockOrLater;\n    } // EIP155 spec:\n    // If block.number >= 2,675,000 and v = CHAIN_ID * 2 + 35 or v = CHAIN_ID * 2 + 36, then when computing\n    // the hash of a transaction for purposes of signing or recovering, instead of hashing only the first six\n    // elements (i.e. nonce, gasprice, startgas, to, value, data), hash nine elements, with v replaced by\n    // CHAIN_ID, r = 0 and s = 0.\n\n\n    var v = ethereumjs_util_1.bufferToInt(this.v);\n    var vAndChainIdMeetEIP155Conditions = v === this.getChainId() * 2 + 35 || v === this.getChainId() * 2 + 36;\n    return vAndChainIdMeetEIP155Conditions && onEIP155BlockOrLater;\n  };\n\n  return Transaction;\n}();\n\nexports.default = Transaction;","map":{"version":3,"sources":["../src/transaction.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar ethereumjs_util_1 = require(\"ethereumjs-util\");\nvar ethereumjs_common_1 = require(\"ethereumjs-common\");\nvar buffer_1 = require(\"buffer\");\n// secp256k1n/2\nvar N_DIV_2 = new ethereumjs_util_1.BN('7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0', 16);\n/**\n * An Ethereum transaction.\n */\nvar Transaction = /** @class */ (function () {\n    /**\n     * Creates a new transaction from an object with its fields' values.\n     *\n     * @param data - A transaction can be initialized with its rlp representation, an array containing\n     * the value of its fields in order, or an object containing them by name.\n     *\n     * @param opts - The transaction's options, used to indicate the chain and hardfork the\n     * transactions belongs to.\n     *\n     * @note Transaction objects implement EIP155 by default. To disable it, use the constructor's\n     * second parameter to set a chain and hardfork before EIP155 activation (i.e. before Spurious\n     * Dragon.)\n     *\n     * @example\n     * ```js\n     * const txData = {\n     *   nonce: '0x00',\n     *   gasPrice: '0x09184e72a000',\n     *   gasLimit: '0x2710',\n     *   to: '0x0000000000000000000000000000000000000000',\n     *   value: '0x00',\n     *   data: '0x7f7465737432000000000000000000000000000000000000000000000000000000600057',\n     *   v: '0x1c',\n     *   r: '0x5e1d3a76fbf824220eafc8c79ad578ad2b67d01b0c2425eb1f1347e8f50882ab',\n     *   s: '0x5bd428537f05f9830e93792f90ea6a3e2d1ee84952dd96edbae9f658f831ab13'\n     * };\n     * const tx = new Transaction(txData);\n     * ```\n     */\n    function Transaction(data, opts) {\n        if (data === void 0) { data = {}; }\n        if (opts === void 0) { opts = {}; }\n        // instantiate Common class instance based on passed options\n        if (opts.common) {\n            if (opts.chain || opts.hardfork) {\n                throw new Error('Instantiation with both opts.common, and opts.chain and opts.hardfork parameter not allowed!');\n            }\n            this._common = opts.common;\n        }\n        else {\n            var chain = opts.chain ? opts.chain : 'mainnet';\n            var hardfork = opts.hardfork ? opts.hardfork : 'petersburg';\n            this._common = new ethereumjs_common_1.default(chain, hardfork);\n        }\n        // Define Properties\n        var fields = [\n            {\n                name: 'nonce',\n                length: 32,\n                allowLess: true,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 'gasPrice',\n                length: 32,\n                allowLess: true,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 'gasLimit',\n                alias: 'gas',\n                length: 32,\n                allowLess: true,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 'to',\n                allowZero: true,\n                length: 20,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 'value',\n                length: 32,\n                allowLess: true,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 'data',\n                alias: 'input',\n                allowZero: true,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 'v',\n                allowZero: true,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 'r',\n                length: 32,\n                allowZero: true,\n                allowLess: true,\n                default: new buffer_1.Buffer([]),\n            },\n            {\n                name: 's',\n                length: 32,\n                allowZero: true,\n                allowLess: true,\n                default: new buffer_1.Buffer([]),\n            },\n        ];\n        // attached serialize\n        ethereumjs_util_1.defineProperties(this, fields, data);\n        /**\n         * @property {Buffer} from (read only) sender address of this transaction, mathematically derived from other parameters.\n         * @name from\n         * @memberof Transaction\n         */\n        Object.defineProperty(this, 'from', {\n            enumerable: true,\n            configurable: true,\n            get: this.getSenderAddress.bind(this),\n        });\n        this._validateV(this.v);\n        this._overrideVSetterWithValidation();\n    }\n    /**\n     * If the tx's `to` is to the creation address\n     */\n    Transaction.prototype.toCreationAddress = function () {\n        return this.to.toString('hex') === '';\n    };\n    /**\n     * Computes a sha3-256 hash of the serialized tx\n     * @param includeSignature - Whether or not to include the signature\n     */\n    Transaction.prototype.hash = function (includeSignature) {\n        if (includeSignature === void 0) { includeSignature = true; }\n        var items;\n        if (includeSignature) {\n            items = this.raw;\n        }\n        else {\n            if (this._implementsEIP155()) {\n                items = this.raw.slice(0, 6).concat([\n                    ethereumjs_util_1.toBuffer(this.getChainId()),\n                    // TODO: stripping zeros should probably be a responsibility of the rlp module\n                    ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0)),\n                    ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0)),\n                ]);\n            }\n            else {\n                items = this.raw.slice(0, 6);\n            }\n        }\n        // create hash\n        return ethereumjs_util_1.rlphash(items);\n    };\n    /**\n     * returns chain ID\n     */\n    Transaction.prototype.getChainId = function () {\n        return this._common.chainId();\n    };\n    /**\n     * returns the sender's address\n     */\n    Transaction.prototype.getSenderAddress = function () {\n        if (this._from) {\n            return this._from;\n        }\n        var pubkey = this.getSenderPublicKey();\n        this._from = ethereumjs_util_1.publicToAddress(pubkey);\n        return this._from;\n    };\n    /**\n     * returns the public key of the sender\n     */\n    Transaction.prototype.getSenderPublicKey = function () {\n        if (!this.verifySignature()) {\n            throw new Error('Invalid Signature');\n        }\n        // If the signature was verified successfully the _senderPubKey field is defined\n        return this._senderPubKey;\n    };\n    /**\n     * Determines if the signature is valid\n     */\n    Transaction.prototype.verifySignature = function () {\n        var msgHash = this.hash(false);\n        // All transaction signatures whose s-value is greater than secp256k1n/2 are considered invalid.\n        if (this._common.gteHardfork('homestead') && new ethereumjs_util_1.BN(this.s).cmp(N_DIV_2) === 1) {\n            return false;\n        }\n        try {\n            var v = ethereumjs_util_1.bufferToInt(this.v);\n            var useChainIdWhileRecoveringPubKey = v >= this.getChainId() * 2 + 35 && this._common.gteHardfork('spuriousDragon');\n            this._senderPubKey = ethereumjs_util_1.ecrecover(msgHash, v, this.r, this.s, useChainIdWhileRecoveringPubKey ? this.getChainId() : undefined);\n        }\n        catch (e) {\n            return false;\n        }\n        return !!this._senderPubKey;\n    };\n    /**\n     * sign a transaction with a given private key\n     * @param privateKey - Must be 32 bytes in length\n     */\n    Transaction.prototype.sign = function (privateKey) {\n        // We clear any previous signature before signing it. Otherwise, _implementsEIP155's can give\n        // different results if this tx was already signed.\n        this.v = new buffer_1.Buffer([]);\n        this.s = new buffer_1.Buffer([]);\n        this.r = new buffer_1.Buffer([]);\n        var msgHash = this.hash(false);\n        var sig = ethereumjs_util_1.ecsign(msgHash, privateKey);\n        if (this._implementsEIP155()) {\n            sig.v += this.getChainId() * 2 + 8;\n        }\n        Object.assign(this, sig);\n    };\n    /**\n     * The amount of gas paid for the data in this tx\n     */\n    Transaction.prototype.getDataFee = function () {\n        var data = this.raw[5];\n        var cost = new ethereumjs_util_1.BN(0);\n        for (var i = 0; i < data.length; i++) {\n            data[i] === 0\n                ? cost.iaddn(this._common.param('gasPrices', 'txDataZero'))\n                : cost.iaddn(this._common.param('gasPrices', 'txDataNonZero'));\n        }\n        return cost;\n    };\n    /**\n     * the minimum amount of gas the tx must have (DataFee + TxFee + Creation Fee)\n     */\n    Transaction.prototype.getBaseFee = function () {\n        var fee = this.getDataFee().iaddn(this._common.param('gasPrices', 'tx'));\n        if (this._common.gteHardfork('homestead') && this.toCreationAddress()) {\n            fee.iaddn(this._common.param('gasPrices', 'txCreation'));\n        }\n        return fee;\n    };\n    /**\n     * the up front amount that an account must have for this transaction to be valid\n     */\n    Transaction.prototype.getUpfrontCost = function () {\n        return new ethereumjs_util_1.BN(this.gasLimit).imul(new ethereumjs_util_1.BN(this.gasPrice)).iadd(new ethereumjs_util_1.BN(this.value));\n    };\n    Transaction.prototype.validate = function (stringError) {\n        if (stringError === void 0) { stringError = false; }\n        var errors = [];\n        if (!this.verifySignature()) {\n            errors.push('Invalid Signature');\n        }\n        if (this.getBaseFee().cmp(new ethereumjs_util_1.BN(this.gasLimit)) > 0) {\n            errors.push([\"gas limit is too low. Need at least \" + this.getBaseFee()]);\n        }\n        if (stringError === false) {\n            return errors.length === 0;\n        }\n        else {\n            return errors.join(' ');\n        }\n    };\n    /**\n     * Returns the rlp encoding of the transaction\n     */\n    Transaction.prototype.serialize = function () {\n        // Note: This never gets executed, defineProperties overwrites it.\n        return ethereumjs_util_1.rlp.encode(this.raw);\n    };\n    /**\n     * Returns the transaction in JSON format\n     * @see {@link https://github.com/ethereumjs/ethereumjs-util/blob/master/docs/index.md#defineproperties|ethereumjs-util}\n     */\n    Transaction.prototype.toJSON = function (labels) {\n        if (labels === void 0) { labels = false; }\n        // Note: This never gets executed, defineProperties overwrites it.\n        return {};\n    };\n    Transaction.prototype._validateV = function (v) {\n        if (v === undefined || v.length === 0) {\n            return;\n        }\n        if (!this._common.gteHardfork('spuriousDragon')) {\n            return;\n        }\n        var vInt = ethereumjs_util_1.bufferToInt(v);\n        if (vInt === 27 || vInt === 28) {\n            return;\n        }\n        var isValidEIP155V = vInt === this.getChainId() * 2 + 35 || vInt === this.getChainId() * 2 + 36;\n        if (!isValidEIP155V) {\n            throw new Error(\"Incompatible EIP155-based V \" + vInt + \" and chain id \" + this.getChainId() + \". See the second parameter of the Transaction constructor to set the chain id.\");\n        }\n    };\n    Transaction.prototype._isSigned = function () {\n        return this.v.length > 0 && this.r.length > 0 && this.s.length > 0;\n    };\n    Transaction.prototype._overrideVSetterWithValidation = function () {\n        var _this = this;\n        var vDescriptor = Object.getOwnPropertyDescriptor(this, 'v');\n        Object.defineProperty(this, 'v', __assign({}, vDescriptor, { set: function (v) {\n                if (v !== undefined) {\n                    _this._validateV(ethereumjs_util_1.toBuffer(v));\n                }\n                vDescriptor.set(v);\n            } }));\n    };\n    Transaction.prototype._implementsEIP155 = function () {\n        var onEIP155BlockOrLater = this._common.gteHardfork('spuriousDragon');\n        if (!this._isSigned()) {\n            // We sign with EIP155 all unsigned transactions after spuriousDragon\n            return onEIP155BlockOrLater;\n        }\n        // EIP155 spec:\n        // If block.number >= 2,675,000 and v = CHAIN_ID * 2 + 35 or v = CHAIN_ID * 2 + 36, then when computing\n        // the hash of a transaction for purposes of signing or recovering, instead of hashing only the first six\n        // elements (i.e. nonce, gasprice, startgas, to, value, data), hash nine elements, with v replaced by\n        // CHAIN_ID, r = 0 and s = 0.\n        var v = ethereumjs_util_1.bufferToInt(this.v);\n        var vAndChainIdMeetEIP155Conditions = v === this.getChainId() * 2 + 35 || v === this.getChainId() * 2 + 36;\n        return vAndChainIdMeetEIP155Conditions && onEIP155BlockOrLater;\n    };\n    return Transaction;\n}());\nexports.default = Transaction;\n//# sourceMappingURL=transaction.js.map"]},"metadata":{},"sourceType":"script"}